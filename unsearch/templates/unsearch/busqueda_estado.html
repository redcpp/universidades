{% extends "unsearch/parts/base.html" %}
{% load staticfiles %}
{% load my_tags %}

{% block nav-global %}
	{% include "unsearch/parts/navbar.html" %}
{% endblock nav-global %}

{% block bodyclass %}
	bg-content
{% endblock bodyclass %}

{% block content %}
<div class="bg-estado">
	<div id="bloque-estado" class="simple-blur vertical-flex">
		<div class="fn-center">
			<div class="draw-circle vertical-flex">
				<img src="{{MEDIA_URL}}{{estado.imagen.url}}" alt="{{MEDIA_URL}}{{estado.imagen.url}}" class="estado-img">
			</div>
			<h1 class="b-title uk-margin-remove">{{estado}}</h1>
		</div>
	</div>
</div>
<div class="uk-grid" id="estado-stats" data-uk-grid-match>
	<a class="uk-width-1-1 estado-section" href="{% url 'unsearch:estado' pk=estado.pk %}">
		<div class="uk-panel uk-text-center vertical-flex">
			<div class="uk-panel-title"><i class="uk-icon-chevron-left"></i> Ver todas las universidades</div>
		</div>
	</a>
</div>
<div id="buscador-estado">
	<form class="uk-form" method="POST">
		{% csrf_token %}
		<div class="uk-form-row">
			<input class="uk-form-large" autofocus name="busqueda" value="{{busqueda}}" onfocus="this.value = this.value;" placeholder="Buscar carrera en {{estado}}">
		</div>
	</form>
</div>

{% regroup universidades by tipo as tipo_list %}

<div id="filtros">
	<div class="chip active" chip="todo">Todo</div>
	{% for tipo in tipo_list %}
		<div class="chip" chip="{{tipo.grouper}}">{{tipo.grouper}}</div>
	{% endfor %}
</div>

<form id="live-search" class="uk-form uk-text-center" action="" method="post">
	<input type="text" id="buscador-live" class="uk-form-width-large uk-form-large shadow-1" value="" placeholder="Buscar universidad">
</form>

<div class="uk-container uk-container-center">
	<div id="lista-unis" class="uk-margin-large-bottom">
	{% for tipo in tipo_list %}
		<div class="bloque-unis" bloque-uni="{{tipo.grouper}}">
			<h3 class="fn-center fn-2em mt-30 mb-20">{{tipo.grouper}}</h3>
			{% regroup tipo.list by nombre as list_universidades %}
			<div class="uk-grid uk-grid-margin uk-flex unis" data-uk-grid-match="{target:'.tarjeta'}">
				{% for universidad in list_universidades|ordenar_matches %}
					<div class="uk-width-medium-1-2 tarjeta-contenedor">
						<article class="uk-comment tarjeta shadow-1">
							<a class="uk-comment-header" href="{% url 'unsearch:universidad' pk=universidad.list.0.pk %}">
								<h4 class="uk-comment-title">{{universidad.grouper|title}}</h4>
							</a>
							<div class="uk-comment-body">
								{% for resultado in universidad.list|dictsort:"matches" %}
									<p>{{resultado.matches}}</p>
								{% endfor %}
							</div>
						</article>
					</div>
				{% endfor %}
			</div>
		</div>
	{% endfor %}
	</div>
</div>

{% endblock content %}

{% block heavyjs %}
<script type="text/javascript">
$(document).ready(function(){

	/* Filtros */
	$('.chip').click(function(){
		var thechosenone = this;
		var thebloque = $(this).attr('chip');
		$('#filtros').children('.chip').each(function() {
			if (this == thechosenone) {
				$(this).addClass('active');
			} else {
				$(this).removeClass('active');
			}
		});
		if (thebloque == 'todo') {
			$('#lista-unis').children('.bloque-unis').each(function() {
				$(this).show();
			});
		} else {
			$('#lista-unis').children('.bloque-unis').each(function() {
				if ($(this).attr('bloque-uni') == thebloque) {
					$(this).show();
				} else {
					$(this).hide();
				}
			});
		}
	});

	/* Buscador preveer submit */
	$('#live-search').submit(function(e){
		e.preventDefault();
	});
	
	/* Buscador en vivo */
	$('#buscador-live').keyup(function(){
		var filtro = $(this).val();
		$('.unis .tarjeta-contenedor').each(function() {
			// Si no contiene el filtro, fade out
			if ($(this).find('.uk-comment-header').text().search(new RegExp(filtro, 'i')) < 0) {
				$(this).fadeOut();
			} else {
				$(this).show();
			}
		});
	});
});
</script>
{% endblock heavyjs %}